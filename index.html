<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fantasy Football Rankings</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Poppins', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        .dragging {
            opacity: 0.7;
            transform: scale(1.02);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            position: relative;
        }
        .drag-over {
            transform: translateY(-2px);
            transition: transform 0.2s ease;
        }
        .drag-placeholder {
            opacity: 0.3;
            transform: scale(0.95);
            transition: all 0.2s ease;
        }
        .player-item {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }
        .touch-draggable {
            touch-action: manipulation;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        .touch-draggable:active {
            transform: scale(0.98);
            transition: transform 0.1s ease;
        }
        @media (hover: none) and (pointer: coarse) {
            .touch-draggable {
                padding: 0.75rem;
            }
            .notes-section {
                display: none;
            }
        }
        @media (hover: hover) and (pointer: fine) {
            .notes-section {
                display: block;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto p-4 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                <input type="text" id="rankerName" placeholder="Your Name" class="border border-gray-300 rounded-md px-3 py-2">
                <input type="text" id="year" placeholder="Year" value="2025" class="border border-gray-300 rounded-md px-3 py-2">
                <select id="scoringFormat" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="PPR">PPR</option>
                    <option value="Half PPR">Half PPR</option>
                    <option value="Standard">Standard</option>
                    <option value="Superflex">Superflex</option>
                </select>
            </div>
            
            <h1 id="rankingsTitle" class="text-2xl font-bold text-center text-gray-800 mb-4">
                Your 2025 PPR Fantasy Football Rankings
            </h1>

            <div class="flex flex-wrap justify-center gap-4">
                <label class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 cursor-pointer">
                    Load Rankings
                    <input type="file" id="loadFileInput" accept=".json" class="hidden">
                </label>
                <button id="saveBtn" class="bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600">
                    Save Rankings
                </button>
                <button id="draftBtn" class="bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600">
                    Draft Day
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="searchInput" placeholder="Search players..." class="border border-gray-300 rounded-md px-3 py-2">
                <select id="positionFilter" class="border border-gray-300 rounded-md px-3 py-2">
                    <option value="ALL">All Positions</option>
                    <option value="QB">QB</option>
                    <option value="RB">RB</option>
                    <option value="WR">WR</option>
                    <option value="TE">TE</option>
                    <option value="K">K</option>
                    <option value="DST">DST</option>
                </select>
            </div>
        </div>

        <!-- Recently Drafted Section (only visible in draft mode) -->
        <div id="recentlyDraftedSection" class="bg-red-50 rounded-lg shadow-md p-4 mb-6 hidden">
            <h3 class="text-lg font-semibold text-red-800 mb-3">Recently Drafted</h3>
            <div id="recentlyDraftedList" class="space-y-2">
                <!-- Recently drafted players will appear here -->
            </div>
        </div>

        <!-- Rankings List -->
        <div class="bg-white rounded-lg shadow-md p-4">
            <div id="playersList" class="space-y-2">
                <!-- Players will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        let players = [];
        let filteredPlayers = [];
        let expandedPlayerId = null;
        let draftedPlayers = [];
        let isDraftMode = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateTitle();
            loadPlayersFromFile();
        });

        function setupEventListeners() {
            document.getElementById('rankerName').addEventListener('input', updateTitle);
            document.getElementById('year').addEventListener('input', updateTitle);
            document.getElementById('scoringFormat').addEventListener('change', updateTitle);
            document.getElementById('searchInput').addEventListener('input', filterPlayers);
            document.getElementById('positionFilter').addEventListener('change', filterPlayers);
            document.getElementById('loadFileInput').addEventListener('change', loadRankings);
            document.getElementById('saveBtn').addEventListener('click', saveRankings);
            document.getElementById('draftBtn').addEventListener('click', toggleDraftMode);
        }

        function loadPlayersFromFile() {
            fetch('./players.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Players file not found');
                    }
                    return response.json();
                })
                .then(data => {
                    players = data.players.map((player, index) => ({
                        ...player,
                        id: player.id || `player-${index}`,
                        risk: player.risk || 'Medium',
                        notes: player.notes || '',
                        overallRank: player.overallRank || index + 1
                    }));
                    recalculateRanks();
                    filterPlayers();
                })
                .catch(error => {
                    console.error('Error loading players.json:', error);
                    // Don't alert on load failure - user can upload their own file
                });
        }

        function updateTitle() {
            const name = document.getElementById('rankerName').value;
            const year = document.getElementById('year').value || '2025';
            const format = document.getElementById('scoringFormat').value || 'PPR';
            
            const titleText = name ? `${name}'s ${year} ${format} Fantasy Football Rankings` : `${year} ${format} Fantasy Football Rankings`;
            document.getElementById('rankingsTitle').textContent = titleText;
        }

        function recalculateRanks() {
            const positionCounts = {};
            players.forEach((player, index) => {
                if (!positionCounts[player.position]) {
                    positionCounts[player.position] = 0;
                }
                positionCounts[player.position]++;
                player.overallRank = index + 1;
                player.positionRank = positionCounts[player.position];
            });
        }

        function filterPlayers() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const position = document.getElementById('positionFilter').value;
            
            filteredPlayers = players.filter(player => {
                const matchesSearch = player.name.toLowerCase().includes(search) || 
                                    player.team.toLowerCase().includes(search);
                const matchesPosition = position === 'ALL' || player.position === position;
                return matchesSearch && matchesPosition;
            });
            
            renderPlayers();
        }

        function renderPlayers() {
            const container = document.getElementById('playersList');
            container.innerHTML = '';

            filteredPlayers.forEach((player, index) => {
                const playerDiv = createPlayerElement(player, index);
                container.appendChild(playerDiv);
            });
        }

        function createPlayerElement(player, index) {
            const div = document.createElement('div');
            div.className = `player-item ${getRiskColor(player.risk)} border rounded-lg transition-all hover:shadow-md`;
            
            // Only make draggable if not in draft mode
            if (!isDraftMode) {
                div.draggable = true;
                div.className += ' cursor-move touch-draggable';
                // Add drag event listeners
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                div.addEventListener('dragend', handleDragEnd);
                
                // Add touch event listeners for better mobile support
                div.addEventListener('touchstart', handleTouchStart, { passive: false });
                div.addEventListener('touchmove', handleTouchMove, { passive: false });
                div.addEventListener('touchend', handleTouchEnd, { passive: false });
            }
            
            div.dataset.playerId = player.id;
            div.dataset.index = index;

            const actionButton = isDraftMode ? 
                `<button onclick="draftPlayer('${player.id}')" 
                        class="bg-red-600 w-8 h-8 rounded text-xs font-bold text-white hover:bg-red-700 flex items-center justify-center"
                        title="Draft Player">
                    D
                </button>` :
                `<button onclick="cycleRisk('${player.id}')" 
                        class="${getRiskButtonColor(player.risk)} w-8 h-8 rounded text-xs font-bold text-white hover:opacity-80 flex items-center justify-center"
                        title="${player.risk} Risk">
                    ${getRiskSymbol(player.risk)}
                </button>`;

            const notesContent = isDraftMode ? 
                `<div class="w-full border border-gray-300 rounded px-2 py-1 text-sm h-12 leading-tight bg-gray-100 flex items-center text-gray-600">${player.notes || ''}</div>` :
                `<textarea placeholder="Add notes..." 
                          onchange="updatePlayerNotes('${player.id}', this.value)"
                          maxlength="100"
                          class="w-full border border-gray-300 rounded px-2 py-1 text-sm resize-none h-12 leading-tight">${player.notes}</textarea>`;

            div.innerHTML = `
                <div class="p-2">
                    <div class="flex items-center gap-1">
                        <!-- Rank -->
                        <div class="flex-shrink-0 w-12 text-center">
                            <div class="font-bold text-2xl">${player.overallRank}</div>
                        </div>

                        <!-- Position Rank -->
                        <div class="flex-shrink-0">
                            <span class="${getPositionColor(player.position)} px-2 py-1 rounded text-sm font-medium">
                                ${player.position}${player.positionRank}
                            </span>
                        </div>

                        <!-- Player Info -->
                        <div class="flex-grow px-2">
                            <div class="font-semibold text-gray-800">${player.name}</div>
                            <div class="text-xs text-gray-600">${player.team}</div>
                        </div>

                        <!-- Notes Section -->
                        <div class="notes-section px-2 w-80 md:w-96 lg:w-[500px] xl:w-[600px]">
                            ${notesContent}
                        </div>

                        <!-- Action Button (Risk or Draft) -->
                        <div class="flex-shrink-0 flex items-center justify-center w-10">
                            ${actionButton}
                        </div>
                    </div>
                </div>
            `;

            return div;
        }

        function cycleRisk(playerId) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                const risks = ['Low', 'Medium', 'High'];
                const currentIndex = risks.indexOf(player.risk);
                const nextIndex = (currentIndex + 1) % risks.length;
                player.risk = risks[nextIndex];
                filterPlayers();
            }
        }

        function toggleDraftMode() {
            isDraftMode = !isDraftMode;
            const btn = document.getElementById('draftBtn');
            const section = document.getElementById('recentlyDraftedSection');
            
            if (isDraftMode) {
                btn.textContent = 'Exit Draft';
                btn.className = 'bg-red-500 text-white px-4 py-2 rounded-md hover:bg-red-600';
                section.classList.remove('hidden');
            } else {
                btn.textContent = 'Draft Day';
                btn.className = 'bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600';
                section.classList.add('hidden');
            }
            
            renderPlayers();
        }

        function draftPlayer(playerId) {
            const playerIndex = players.findIndex(p => p.id === playerId);
            if (playerIndex !== -1) {
                const [draftedPlayer] = players.splice(playerIndex, 1);
                draftedPlayers.unshift(draftedPlayer); // Add to beginning of drafted list
                
                // Don't recalculate ranks - keep original ranks
                filterPlayers();
                renderRecentlyDrafted();
            }
        }

        function undraftPlayer(playerId) {
            const playerIndex = draftedPlayers.findIndex(p => p.id === playerId);
            if (playerIndex !== -1) {
                const [undraftedPlayer] = draftedPlayers.splice(playerIndex, 1);
                players.push(undraftedPlayer);
                
                // Sort players back to original ranking order
                players.sort((a, b) => a.overallRank - b.overallRank);
                
                filterPlayers();
                renderRecentlyDrafted();
            }
        }

        function renderRecentlyDrafted() {
            const container = document.getElementById('recentlyDraftedList');
            container.innerHTML = '';

            draftedPlayers.slice(0, 3).forEach(player => { // Show last 3 drafted
                const div = document.createElement('div');
                div.className = 'bg-gray-100 border rounded-lg p-2 cursor-pointer hover:bg-gray-200';
                div.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="${getPositionColor(player.position)} px-2 py-1 rounded text-xs font-medium">
                            ${player.position}
                        </span>
                        <div class="flex-grow">
                            <span class="font-semibold">${player.name}</span>
                            <span class="text-xs text-gray-600 ml-2">${player.team}</span>
                        </div>
                        <button onclick="undraftPlayer('${player.id}')" 
                                class="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600">
                            UNDO
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updatePlayerNotes(playerId, notes) {
            const player = players.find(p => p.id === playerId);
            if (player) {
                player.notes = notes;
            }
        }

        function getRiskColor(risk) {
            switch (risk) {
                case 'High': return 'bg-red-200 border-red-300';
                case 'Medium': return 'bg-yellow-200 border-yellow-300';
                case 'Low': return 'bg-green-200 border-green-300';
                default: return 'bg-gray-200 border-gray-300';
            }
        }

        function getRiskButtonColor(risk) {
            switch (risk) {
                case 'High': return 'bg-red-600';
                case 'Medium': return 'bg-yellow-600';
                case 'Low': return 'bg-green-600';
                default: return 'bg-gray-600';
            }
        }

        function getRiskSymbol(risk) {
            switch (risk) {
                case 'High': return 'H';
                case 'Medium': return 'M';
                case 'Low': return 'L';
                default: return '?';
            }
        }

        function getPositionColor(position) {
            switch (position) {
                case 'QB': return 'text-purple-600 bg-purple-100';
                case 'RB': return 'text-blue-600 bg-blue-100';
                case 'WR': return 'text-green-600 bg-green-100';
                case 'TE': return 'text-orange-600 bg-orange-100';
                case 'K': return 'text-pink-600 bg-pink-100';
                case 'DST': return 'text-gray-600 bg-gray-100';
                default: return 'text-gray-600 bg-gray-100';
            }
        }

        // Drag and Drop functionality - Simplified and more reliable
        let draggedElement = null;
        let draggedIndex = -1;
        let isDragging = false;
        let touchStartY = 0;
        let longPressTimer = null;

        function handleDragStart(e) {
            // Reset any stuck state
            cleanupDragState();
            
            draggedElement = this;
            draggedIndex = parseInt(this.dataset.index);
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            isDragging = true;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            
            if (!isDragging || !draggedElement) return false;
            
            const targetIndex = parseInt(this.dataset.index);
            if (targetIndex !== draggedIndex && targetIndex >= 0) {
                performLiveReorder(targetIndex);
            }
            
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            
            if (isDragging) {
                finalizeDragOperation();
            }
            return false;
        }

        function handleDragEnd(e) {
            cleanupDragState();
        }

        // Touch event handlers - Simplified
        function handleTouchStart(e) {
            if (isDraftMode || isDragging) return;
            
            touchStartY = e.touches[0].clientY;
            
            // Clear any existing timer
            if (longPressTimer) {
                clearTimeout(longPressTimer);
            }
            
            // Start long press timer
            longPressTimer = setTimeout(() => {
                startTouchDrag(this);
            }, 200);
        }

        function handleTouchMove(e) {
            // Cancel long press if finger moves too much during timer
            if (longPressTimer) {
                const currentY = e.touches[0].clientY;
                const deltaY = Math.abs(currentY - touchStartY);
                
                if (deltaY > 15) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
            
            if (isDragging && draggedElement) {
                e.preventDefault();
                
                // Find element under finger
                const touch = e.touches[0];
                const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
                const playerElement = elementBelow?.closest('.player-item');
                
                if (playerElement && playerElement !== draggedElement) {
                    const targetIndex = parseInt(playerElement.dataset.index);
                    if (targetIndex >= 0) {
                        performLiveReorder(targetIndex);
                    }
                }
            }
        }

        function handleTouchEnd(e) {
            // Clear timer
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            if (isDragging) {
                finalizeDragOperation();
            }
        }

        function startTouchDrag(element) {
            // Reset state first
            cleanupDragState();
            
            draggedElement = element;
            draggedIndex = parseInt(element.dataset.index);
            isDragging = true;
            element.classList.add('dragging');
            
            // Haptic feedback
            if (navigator.vibrate) {
                navigator.vibrate(50);
            }
        }

        function performLiveReorder(targetIndex) {
            if (!isDragging || targetIndex === draggedIndex) return;
            
            // Simple visual feedback - just highlight target
            document.querySelectorAll('.drag-over').forEach(el => {
                el.classList.remove('drag-over');
            });
            
            const targetElement = document.querySelector(`[data-index="${targetIndex}"]`);
            if (targetElement) {
                targetElement.classList.add('drag-over');
            }
        }

        function finalizeDragOperation() {
            if (!draggedElement || !isDragging) {
                cleanupDragState();
                return;
            }
            
            // Find target from highlighted element
            const targetElement = document.querySelector('.drag-over');
            if (targetElement) {
                const draggedPlayerId = draggedElement.dataset.playerId;
                const targetPlayerId = targetElement.dataset.playerId;
                
                const draggedPlayerIndex = players.findIndex(p => p.id === draggedPlayerId);
                const targetPlayerIndex = players.findIndex(p => p.id === targetPlayerId);
                
                if (draggedPlayerIndex !== -1 && targetPlayerIndex !== -1 && draggedPlayerIndex !== targetPlayerIndex) {
                    // Move player in array
                    const [draggedPlayer] = players.splice(draggedPlayerIndex, 1);
                    players.splice(targetPlayerIndex, 0, draggedPlayer);
                    
                    recalculateRanks();
                    filterPlayers();
                }
            }
            
            cleanupDragState();
        }

        function cleanupDragState() {
            // Clear all drag-related classes and state
            document.querySelectorAll('.dragging, .drag-over, .drag-placeholder').forEach(el => {
                el.classList.remove('dragging', 'drag-over', 'drag-placeholder');
                el.style.transform = '';
            });
            
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            
            draggedElement = null;
            draggedIndex = -1;
            isDragging = false;
        }

        function loadRankings(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        // Check if this is a basic player list or full rankings
                        if (data.players && !data.rankerName) {
                            // Basic player list - initialize with defaults
                            players = data.players.map((player, index) => ({
                                ...player,
                                id: player.id || `player-${index}`,
                                risk: player.risk || 'Medium',
                                notes: player.notes || '',
                                overallRank: player.overallRank || index + 1
                            }));
                            recalculateRanks();
                        } else {
                            // Full rankings file
                            document.getElementById('rankerName').value = data.rankerName || '';
                            document.getElementById('year').value = data.year || '2025';
                            document.getElementById('scoringFormat').value = data.scoringFormat || 'PPR';
                            players = data.players || [];
                            draftedPlayers = data.draftedPlayers || [];
                        }
                        
                        updateTitle();
                        filterPlayers();
                        if (isDraftMode) {
                            renderRecentlyDrafted();
                        }
                    } catch (error) {
                        alert('Error loading file: ' + error.message);
                    }
                };
                reader.readAsText(file);
            }
        }

        function saveRankings() {
            const data = {
                rankerName: document.getElementById('rankerName').value,
                year: document.getElementById('year').value,
                scoringFormat: document.getElementById('scoringFormat').value,
                players: players,
                draftedPlayers: draftedPlayers
            };

            const rankerName = data.rankerName || 'Unknown';
            const year = data.year || '2025';
            const scoring = data.scoringFormat || 'PPR';
            const filename = `${rankerName}${year}${scoring}Rankings.json`;

            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>